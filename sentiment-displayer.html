<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/maps-icons.html">
<link rel="import" href="../iron-icons/social-icons.html">
<link rel="import" href="../jquery/social-icons.html">
<dom-module id="sentiment-displayer">
  <link rel="import" type="css" href="sentiment.css">
  <script src="bower_components/d3/d3.min.js"></script>
  <script src="bower_components/jquery/jquery.min.js"></script>  
  <template>
    <div id="content">
    </div>
  </template>

    <script>
      //Create the SVG Viewport
                  var w = document.getElementById('content').clientWidth;

              var h = document.getElementById('content').clientHeight;
      var numberMax = 0;
        Polymer({
            is: 'sentiment-displayer',
            properties: {
              total: {
                type: Number,
                value: 0
              },
              stylebg: {
                type: String,
                value: 'bg-yellow'
              },
              data: {
                type: Object,
                observer: '_dataChanged'              
              },
              title: {
                type: String,
                value: 'Elements selected'
              },
              subtitle: {
                type: String,
                value: 'Total elements'
              },
              icon: {
                type: String,
                value: 'delete'
              },
              number: {
                type: Number,
                value: 0
              },
              object: {
                type: String
              },
              aggkey: {
                type: String,
                value: 'category'
              },
              filters: {
                type: Array,
                notify: true,
                value: function() { return []; }
              }
            },

            kFormatter: function(num){
              return num > 999 ? (num/1000).toFixed(1) + 'k' : num
            },

            _dataChanged: function() {
              console.log("data has changed")
              if(this.data == undefined || this.data.hits == undefined){
                console.log("No data");
                return;
              }
              numberMax = this.data.hits.total;
              var idNum = this.$.number;
              var idBar = this.$.barprogress;
              var object = this.object;
              if (object != undefined){
                var hits = this.data.aggregations[this.aggkey].buckets;
                var selected = 0;
                hits.forEach(function(entry) {
                  if(entry.key == object){
                    //console.log("el object es: "+object+" el entry.key es: "+entry.key)
                    selected = entry.doc_count;
                  }
                });
                console.log(selected);
                idNum.innerHTML = this.kFormatter(selected);
                progress = 100*selected/numberMax;
                idBar.style.width = progress+"%";
                this.total = this.kFormatter(numberMax);
              }
              else{
                //console.log(this.data.hits)
                var num = this.data.hits.total > 999 ? (this.data.hits.total/1000).toFixed(1) + 'k' : this.data.hits.total;
                idNum.innerHTML = num;
    this.total = num;
                idBar.style.width = "100%";
              }
            },
            ready: function(){
              
              var svgContainer = d3.select("#content").append("svg")
                                                   .attr("width", "100%")
                                                   .attr("height", "100%");

              console.log(w + " " + h);
              var hred= h -10;
              var hmed= h/2;
              //Create the Scale we will use for the Axis
              var n = 1;

              //Create the Axis
              //Create an SVG group Element for the Axis elements and call the xAxis function
              var jsonCircles = [
                { "sec": 0, "sentiment": 0},
                { "sec": 1, "sentiment": 1},
                { "sec": 2, "sentiment": -1},
                { "sec": 3, "sentiment": -1},
                { "sec": 4, "sentiment": 1},  
                { "sec": 5, "sentiment": 1},
                { "sec": 6, "sentiment": -1},
                { "sec": 7, "sentiment": 1},
                { "sec": 8, "sentiment": 1}, 
                { "sec": 9, "sentiment": -1},
                { "sec": 10, "sentiment": 1},
                { "sec": 11, "sentiment": 1},
                { "sec": 12, "sentiment": -1},
                { "sec": 13, "sentiment": -1},
                { "sec": 14, "sentiment": 1},  
                { "sec": 15, "sentiment": 1},
                { "sec": 16, "sentiment": -1},
                { "sec": 17, "sentiment": 1},
                { "sec": 18, "sentiment": 1},
                { "sec": 19, "sentiment": -1},
                { "sec": 20, "sentiment": 1},  
                { "sec": 21, "sentiment": 1},
                { "sec": 22, "sentiment": -1},
                { "sec": 23, "sentiment": -1},
                { "sec": 24, "sentiment": 1},  
                { "sec": 25, "sentiment": 1},
                { "sec": 26, "sentiment": -1},
                { "sec": 27, "sentiment": 1},
                { "sec": 28, "sentiment": 1}];


              var circles = svgContainer.selectAll("#content")
                                        .data(jsonCircles)
                                        .enter()
                                        .append("circle");  
                    var y0 = d3.scale.linear().domain([-1,1]).range([0, -hred]);
                    var yAxis = d3.svg.axis().scale(y0).orient("left").ticks(5);
            	       window.setInterval(function(){

                      axisScale = d3.scale.linear().domain([0, n]).range([0, w]);
                      xAxis = d3.svg.axis().scale(axisScale);
                      d3.select("svg").select("g").remove();
                      
                      d3.select("svg").select("g").remove();
                      d3.select("path").remove();
                      axisGroup = svgContainer.append("g").attr("transform", "translate( 500 ," + hmed + ")").call(xAxis);
                      circleAttributes = circles
                                       .attr("cx", function (d) { return d.sec*w/n +50; })
                                       .attr("cy", function (d) { return -d.sentiment * hmed*0.5+ hmed; })
                                       .attr("r", function (d) { return 5; }); 
                        lineFunction = d3.svg.line()
                                          .x(function(d) { return d.sec*w/n +50; })
                                          .y(function(d) { return -d.sentiment * hmed*0.5+ hmed; })
                                          .interpolate("linear");               
                        lineGraph = svgContainer.append("path")
                                            .attr("d", lineFunction(jsonCircles))
                                            .attr("stroke", "blue")
                                            .attr("stroke-width", 2)
                                            .attr("fill", "none");
                      axisGroup = svgContainer.append("g").attr("transform", "translate( 5,"+ h + ")").call(yAxis);
                        n++;
                    },1000);
            }

        });
    </script>

</dom-module>
